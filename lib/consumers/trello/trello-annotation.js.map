{"version":3,"sources":["../../../src/consumers/trello/trello-annotation.es6"],"names":[],"mappings":"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","file":"trello-annotation.js","sourcesContent":["import Promise from 'bluebird';\n\nimport * as PATTERNS from './patterns';\nimport * as ENDPOINTS from './endpoints';\n\nlet getCommentPadding = function(comment){\n\treturn comment[0].split('').filter(function(char){\n\t\treturn char === '\\t';\n\t}).join('');\n}\n\nexport default class TrelloAnnotation{\n\tconstructor(annotation, filepath){\n\t\tObject.assign(this, this.parse(annotation));\n\t\tthis.filepath = filepath;\n\t}\n\n\ttoFile(){\n\t\tlet result = {\n\t\t\trange: this.annotation.comment.range,\n\t\t\tcontent: this.content,\n\t\t\tpadding: getCommentPadding(this.annotation.comment.originalContent)\n\t\t};\n\n\t\tresult.content[0] = this.annotation.type+': '+result.content[0];\n\t\tresult.content.push('TR_ID: '+this.id);\n\t\tresult.content.push('TR_STATUS: '+this.status);\n\n\t\treturn result;\n\t}\n\n\tparse(annotation){\n\t\tlet result = {\n\t\t\tannotation: annotation,\n\t\t\tisTrello: false,\n\t\t\tcontent: null,\n\t\t\tid: null,\n\t\t\tstatus: null,\n\t\t\tlabel: null\n\t\t};\n\n\t\tresult.content = annotation.content.slice(0);\n\n\t\t// A single line cannot be a Trello Annotation\n\t\tif(result.content.length > 1){\n\t\t\tresult.content = result.content.map(function(line, index, array){\n\t\t\t\tif(PATTERNS.ID.test(line)){\n\t\t\t\t\tresult.id = line.replace(PATTERNS.ID, '');\n\t\t\t\t\treturn '';\n\t\t\t\t}\n\n\t\t\t\tif(PATTERNS.STATUS.test(line)){\n\t\t\t\t\tresult.status = line.replace(PATTERNS.STATUS, '');\n\t\t\t\t\treturn '';\n\t\t\t\t}\n\n\t\t\t\treturn line;\n\t\t\t}).filter(function(line){\n\t\t\t\treturn line.length > 0;\n\t\t\t});\n\n\n\n\t\t\tif(result.id){\n\t\t\t\tresult.isTrello = true;\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tprocess(lists){\n\t\tthis.associatedCard = this.getAssociatedCard(lists);\n\n\t\tlet list;\n\n\t\tif(!this.associatedCard){\n\t\t\tlist = this.getListByStatus(lists, 'To Do');\n\t\t\tthis.idList = list.id;\n\t\t\tthis.status = 'To Do';\n\t\t}\n\t\telse{\n\t\t\tlist = this.getListByStatus(lists, this.status);\n\t\t\tthis.idList = list.id;\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tpost(trello){\n\t\tlet postData = this.getTrelloPostData(),\n\t\t\tmethod = postData.id ? 'put' : 'post',\n\t\t\turl = postData.id ? ENDPOINTS.UPDATE_CARD_URL(postData.id) : ENDPOINTS.NEW_CARD_URL;\n\n\t\tif(this.checkNeedsUpdating(postData)){\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\ttrello[method](url, postData, (err, data) => {\n\t\t\t\t\tif(err){\n\t\t\t\t\t\treject(err);\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\tthis.updateFromTrello(data);\n\t\t\t\t\t\tresolve(this);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\telse{\n\t\t\treturn Promise.resolve(this);\n\t\t}\n\t}\n\n\tgetTrelloPostData(){\n\t\tlet result = {\n\t\t\tid: this.id,\n\t\t\tidList: this.idList,\n\t\t\tname: this.annotation.type+': '+this.content[0],\n\t\t\tdesc: ''\n\t\t};\n\n\t\tif(this.content.length > 1){\n\t\t\tresult.desc = this.content.slice(1).join('\\n');\n\t\t\tresult.desc += '\\n\\n';\n\t\t}\n\n\t\tresult.desc += `**File:** ${this.filepath}\\n**Line:** ${this.annotation.comment.range.start}`;\n\n\t\treturn result;\n\t}\n\n\tcheckNeedsUpdating(currentData){\n\t\tlet needsUpdate;\n\n\t\tif(!this.associatedCard){\n\t\t\tneedsUpdate = true;\n\t\t}\n\t\telse{\n\t\t\tneedsUpdate = ['idList', 'name', 'desc'].some((key) => {\n\t\t\t\treturn currentData[key] !== this.associatedCard[key];\n\t\t\t});\n\t\t}\n\t\treturn needsUpdate;\n\t}\n\n\tupdateFromTrello(data){\n\t\tthis.id = data.id;\n\t}\n\n\tgetAssociatedCard(lists){\n\t\tlet result = null;\n\n\t\tif(this.id){\n\t\t\tresult = lists.reduce(function(annotation, list){\n\t\t\t\treturn list.cards.reduce(function(annotation, card){\n\t\t\t\t\tif(card.id === annotation.id){\n\t\t\t\t\t\treturn card;\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\treturn annotation;\n\t\t\t\t\t}\n\t\t\t\t}, annotation);\n\t\t\t}, this);\n\n\t\t\tif(result === this){\n\t\t\t\tresult = null;\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tgetListByStatus(lists, status){\n\t\tlet result = lists.filter(function(list){\n\t\t\treturn list.name === status;\n\t\t});\n\n\t\tif(result.length > 0){\n\t\t\tresult = result[0];\n\t\t}\n\t\telse{\n\t\t\tresult = null;\n\t\t}\n\n\t\treturn result;\n\n\t}\n}\n"]}